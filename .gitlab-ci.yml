stages:
  - test
  - security
  - build
  - deploy

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"

services:
  - docker:dind

before_script:
  - docker info

# Frontend Tests
test:frontend:
  stage: test
  image: node:18
  cache:
    paths:
      - frontend/node_modules/
  script:
    - cd frontend
    - npm ci
    - npm run lint --if-present
    - npm test -- --coverage --watchAll=false
    - npm run build
  artifacts:
    paths:
      - frontend/build/
    reports:
      coverage_report:
        coverage_format: cobertura
        path: frontend/coverage/cobertura-coverage.xml
  only:
    - merge_requests
    - main
    - develop

# Backend Tests
test:backend:
  stage: test
  image: python:3.11
  services:
    - postgres:15
    - redis:7-alpine
  variables:
    POSTGRES_DB: test_db
    POSTGRES_USER: test_user
    POSTGRES_PASSWORD: test_password
    DATABASE_URL: postgresql://test_user:test_password@postgres:5432/test_db
    REDIS_URL: redis://redis:6379/0
    FLASK_ENV: testing
  cache:
    paths:
      - ~/.cache/pip/
  script:
    - cd backend
    - pip install -r requirements.txt
    - pip install pytest pytest-cov flake8
    - flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
    - python -m pytest tests/ --cov=app --cov-report=xml --cov-report=html
  artifacts:
    paths:
      - backend/htmlcov/
    reports:
      coverage_report:
        coverage_format: cobertura
        path: backend/coverage.xml
  only:
    - merge_requests
    - main
    - develop

# Ansible Tests
test:ansible:
  stage: test
  image: python:3.11
  script:
    - pip install ansible ansible-lint yamllint
    - yamllint ansible/
    - cd ansible
    - ansible-lint *.yml
    - ansible-playbook --syntax-check *.yml
  only:
    - merge_requests
    - main
    - develop

# Security Scanning
security:trivy:
  stage: security
  image: aquasec/trivy:latest
  script:
    - trivy fs --exit-code 0 --no-progress --format table .
    - trivy fs --exit-code 1 --no-progress --severity HIGH,CRITICAL .
  only:
    - merge_requests
    - main

security:docker:
  stage: security
  image: docker:latest
  script:
    - docker build -t devops-frontend:test frontend/
    - docker build -t devops-backend:test backend/
    - docker build -t devops-ansible:test ansible/
    - trivy image --exit-code 0 devops-frontend:test
    - trivy image --exit-code 0 devops-backend:test
    - trivy image --exit-code 0 devops-ansible:test
  only:
    - merge_requests
    - main

# Integration Tests
test:integration:
  stage: test
  image: docker/compose:latest
  services:
    - docker:dind
  script:
    - docker-compose build
    - docker-compose up -d
    - sleep 60
    # Health checks
    - curl -f http://localhost:3000 || exit 1
    - curl -f http://localhost:5000/health || exit 1
    - curl -f http://localhost:8080 || exit 1
    - curl -f http://localhost:9090 || exit 1
    - curl -f http://localhost:3001 || exit 1
    # API tests
    - curl -f http://localhost:5000/api/servers || exit 1
    - curl -f http://localhost:5000/api/metrics || exit 1
    - curl -f http://localhost:5000/api/alerts || exit 1
  after_script:
    - docker-compose logs
    - docker-compose down -v
  only:
    - merge_requests
    - main

# Build and Push Images
build:images:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  before_script:
    - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin $CI_REGISTRY
  script:
    - docker build -t $CI_REGISTRY_IMAGE/frontend:$CI_COMMIT_SHA frontend/
    - docker build -t $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHA backend/
    - docker build -t $CI_REGISTRY_IMAGE/ansible:$CI_COMMIT_SHA ansible/
    
    - docker push $CI_REGISTRY_IMAGE/frontend:$CI_COMMIT_SHA
    - docker push $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHA
    - docker push $CI_REGISTRY_IMAGE/ansible:$CI_COMMIT_SHA
    
    # Tag as latest if main branch
    - |
      if [ "$CI_COMMIT_BRANCH" = "main" ]; then
        docker tag $CI_REGISTRY_IMAGE/frontend:$CI_COMMIT_SHA $CI_REGISTRY_IMAGE/frontend:latest
        docker tag $CI_REGISTRY_IMAGE/backend:$CI_COMMIT_SHA $CI_REGISTRY_IMAGE/backend:latest
        docker tag $CI_REGISTRY_IMAGE/ansible:$CI_COMMIT_SHA $CI_REGISTRY_IMAGE/ansible:latest
        
        docker push $CI_REGISTRY_IMAGE/frontend:latest
        docker push $CI_REGISTRY_IMAGE/backend:latest
        docker push $CI_REGISTRY_IMAGE/ansible:latest
      fi
  only:
    - main
    - develop

# Deploy to Staging
deploy:staging:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client curl
    - eval $(ssh-agent -s)
    - echo "$STAGING_SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan $STAGING_HOST >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
  script:
    - |
      ssh $STAGING_USER@$STAGING_HOST << EOF
        cd /opt/devops-monitoring-platform
        git pull origin main
        docker-compose pull
        docker-compose up -d
        sleep 30
        # Health checks
        curl -f http://localhost:3000 || exit 1
        curl -f http://localhost:5000/health || exit 1
        curl -f http://localhost:5000/api/servers || exit 1
        echo "Staging deployment successful!"
      EOF
  environment:
    name: staging
    url: http://$STAGING_HOST
  only:
    - main

# Deploy to Production
deploy:production:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client curl
    - eval $(ssh-agent -s)
    - echo "$PRODUCTION_SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan $PRODUCTION_HOST >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
  script:
    - |
      ssh $PRODUCTION_USER@$PRODUCTION_HOST << EOF
        cd /opt/devops-monitoring-platform
        
        # Create backup
        docker-compose exec postgres pg_dump -U devops_user monitoring_db > backup_$(date +%Y%m%d_%H%M%S).sql
        
        # Deploy
        git pull origin main
        docker-compose pull
        docker-compose up -d
        sleep 60
        
        # Health checks
        curl -f http://localhost:3000 || exit 1
        curl -f http://localhost:5000/health || exit 1
        curl -f http://localhost:5000/api/servers || exit 1
        curl -f http://localhost:5000/api/metrics || exit 1
        curl -f http://localhost:5000/api/alerts || exit 1
        
        # Check monitoring services
        curl -f http://localhost:8080/nagios/ || exit 1
        curl -f http://localhost:9090/-/healthy || exit 1
        curl -f http://localhost:3001/api/health || exit 1
        
        echo "Production deployment successful!"
      EOF
  environment:
    name: production
    url: http://$PRODUCTION_HOST
  when: manual
  only:
    - main

# Rollback Production (Manual Job)
rollback:production:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$PRODUCTION_SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan $PRODUCTION_HOST >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
  script:
    - |
      ssh $PRODUCTION_USER@$PRODUCTION_HOST << EOF
        cd /opt/devops-monitoring-platform
        git reset --hard HEAD~1
        docker-compose up -d
        echo "Production rollback completed"
      EOF
  environment:
    name: production
    url: http://$PRODUCTION_HOST
  when: manual
  only:
    - main